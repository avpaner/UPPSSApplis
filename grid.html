<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UPLB AMIS Schedule Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --primary: #531C79; 
            --border: #E2E8F0; 
            --blocked-red: #BE4AAD; 
            --reschedule-amber: #D97706;
            --initials-green: #49A631;
            --glow-v: rgba(83, 28, 121, 0.4);
            --glow-a: rgba(217, 119, 6, 0.4);
        }
        body { font-family: 'Inter', sans-serif; background: #F8FAFC; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        body.edit-mode-active { 
            box-shadow: inset 0 0 0 8px var(--primary), 0 0 25px var(--glow-v);
            animation: editModePulse 1.5s ease-in-out infinite;
            border: 4px solid var(--primary);
        }
        
        @keyframes editModePulse {
            0%, 100% { 
                box-shadow: inset 0 0 0 8px var(--primary), 0 0 25px var(--glow-v);
                border-color: var(--primary);
            }
            50% { 
                box-shadow: inset 0 0 0 8px var(--primary), 0 0 50px var(--glow-v);
                border-color: #7429a3;
            }
        }
        
        body.reschedule-mode-active { box-shadow: inset 0 0 0 8px var(--reschedule-amber), 0 0 25px var(--glow-a); }

        #mode-banner { 
            display: none; 
            color: white; 
            text-align: center; 
            font-weight: 900; 
            font-size: 12px; 
            padding: 10px 0; 
            letter-spacing: 2px; 
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        body.edit-mode-active #mode-banner, body.reschedule-mode-active #mode-banner { display: block; }
        body.edit-mode-active #mode-banner { 
            background: var(--primary);
            animation: bannerBlink 1s ease-in-out infinite;
        }
        
        @keyframes bannerBlink {
            0%, 100% { 
                opacity: 1; 
                background: var(--primary);
            }
            50% { 
                opacity: 0.85; 
                background: #7429a3;
            }
        }
        
        body.reschedule-mode-active #mode-banner { background: var(--reschedule-amber); }
        
        body.edit-mode-active * {
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
        }

        .app-title { color: var(--primary); font-size: 28px; font-weight: 900; text-align: center; margin: 15px 0; }
        .table-container { flex-grow: 1; background: white; overflow: auto; width: 100%; border-top: 1px solid var(--border); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; table-layout: fixed; }
        
        thead th { 
            position: sticky; 
            top: 0; 
            background: white; 
            padding: 15px; 
            font-size: 0.8rem; 
            font-weight: 800; 
            color: var(--primary); 
            border-bottom: 2px solid var(--primary); 
            z-index: 400;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        thead th:not(:first-child):hover {
            background: #F3E5F5;
            color: #BE4AAD;
        }
        
        .time-col { 
            position: sticky; 
            left: 0; 
            background: #FFFFFF; 
            width: 140px; 
            z-index: 800; 
            border-right: 1px solid var(--border); 
            text-align: left; 
            font-size: 10px; 
            font-weight: 700; 
            color: var(--primary);
            padding: 8px 12px !important;
            line-height: 1.4;
        }
        
        .time-label {
            display: block;
        }
        
        .time-start {
            font-size: 11px;
            font-weight: 800;
            color: var(--primary);
        }
        
        .time-end {
            font-size: 9px;
            color: #64748b;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .time-separator {
            display: inline-block;
            margin: 0 4px;
            color: #94a3b8;
        }
        
        td { padding: 4px; border-bottom: 1px solid #F1F5F9; }
        .slot { 
            min-height: 52px; 
            height: auto; 
            background: #F8FAFC; 
            border-radius: 6px; 
            border: 1px solid #EDF2F7; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 4px; 
            padding: 6px; 
            align-content: flex-start; 
            transition: 0.1s; 
            position: relative; 
        }
        .slot.available { background: #F3E5F5 !important; border-color: var(--primary); cursor: pointer; }
        .slot.locked { background: #FCE4EC !important; border-color: var(--blocked-red); cursor: pointer; }
        .slot.source-selected { outline: 3px solid var(--reschedule-amber); outline-offset: -3px; background: #FEF3C7 !important; }
        
        body.edit-mode-active .slot.available,
        body.edit-mode-active .slot.locked {
            cursor: grab;
        }
        
        body.edit-mode-active .slot.available:active,
        body.edit-mode-active .slot.locked:active {
            cursor: grabbing;
        }

        .initials-badge { background: var(--initials-green) !important; color: white !important; font-size: 10px; font-weight: 700; padding: 3px 6px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); white-space: nowrap; pointer-events: none; }
        .location-tag { width: 100%; color: var(--primary); font-size: 9px; font-weight: 800; margin-top: 4px; border-top: 1px solid rgba(83, 28, 121, 0.1); padding-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        #location-picker { position: fixed; background: white; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 20000; display: none; padding: 8px; min-width: 170px; max-height: 300px; overflow-y: auto; }
        .loc-option { padding: 10px 14px; font-size: 13px; color: #334155; cursor: pointer; border-radius: 6px; font-weight: 600; transition: all 0.2s; }
        .loc-option:hover { background: #F1F5F9; color: var(--primary); }

        #confirm-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            z-index: 30000;
            padding: 24px;
            min-width: 320px;
            max-width: 400px;
        }
        
        #confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 29999;
        }
        
        .dialog-title {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 12px;
        }
        
        .dialog-message {
            font-size: 14px;
            color: #475569;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .dialog-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dialog-btn-cancel {
            background: #E2E8F0;
            color: #475569;
        }
        
        .dialog-btn-cancel:hover {
            background: #CBD5E1;
        }
        
        .dialog-btn-confirm {
            background: #BE4AAD;
            color: white;
        }
        
        .dialog-btn-confirm:hover {
            background: #9C3C8D;
        }

        .fab-wrapper { position: fixed; bottom: 30px; right: 30px; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        
        .fab-menu { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            align-items: center;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }
        
        .fab-menu.show { 
            max-height: 300px;
            opacity: 1;
        }
        
        .btn-sub { 
            width: 180px; 
            height: 40px; 
            border-radius: 20px; 
            border: none; 
            background: white; 
            color: var(--primary); 
            font-weight: 700; 
            font-size: 11px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            cursor: pointer; 
            transition: all 0.2s;
            transform: translateY(0);
        }
        
        .btn-sub:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .btn-main { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            border: none; 
            background: var(--primary); 
            color: white; 
            font-size: 24px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            transform: rotate(0deg);
            box-shadow: 0 4px 15px rgba(83, 28, 121, 0.3);
        }
        
        .btn-main:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(83, 28, 121, 0.4);
        }
        
        .btn-main.active {
            transform: rotate(135deg);
        }

        #toast { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); background: #334155; color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; display: none; z-index: 10000; }
        
        #csv-upload { display: none; }
    </style>
</head>
<body id="mainBody">

    <div id="mode-banner">‚úçÔ∏è EDIT MODE ACTIVE - CLICK OR DRAG TO SELECT SLOTS</div>
    <div id="location-picker"></div>
    <div id="confirm-overlay"></div>
    <div id="confirm-dialog">
        <div class="dialog-title" id="dialog-title">Confirm Action</div>
        <div class="dialog-message" id="dialog-message">Are you sure?</div>
        <div class="dialog-actions">
            <button class="dialog-btn dialog-btn-cancel" onclick="closeDialog()">Cancel</button>
            <button class="dialog-btn dialog-btn-confirm" id="dialog-confirm">Confirm</button>
        </div>
    </div>
    <h1 class="app-title">AMIS SYNC</h1>
    <div id="toast"></div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>TIME SLOT</th>
                    <th onclick="handleDayClick('Sunday')">SUN</th>
                    <th onclick="handleDayClick('Monday')">MON</th>
                    <th onclick="handleDayClick('Tuesday')">TUE</th>
                    <th onclick="handleDayClick('Wednesday')">WED</th>
                    <th onclick="handleDayClick('Thursday')">THU</th>
                    <th onclick="handleDayClick('Friday')">FRI</th>
                    <th onclick="handleDayClick('Saturday')">SAT</th>
                </tr>
            </thead>
            <tbody id="grid"></tbody>
        </table>
    </div>

    <div class="fab-wrapper">
        <div class="fab-menu" id="fabMenu">
            <button class="btn-sub" onclick="triggerCSVUpload()">üìÑ Upload CSV</button>
            <button class="btn-sub" onclick="toggleRescheduleMode()" id="reschedBtn">üîÑ Reschedule</button>
            <button class="btn-sub" onclick="handleEditClick()" id="editLabel">‚úçÔ∏è Edit Mode</button>
        </div>
        <button class="btn-main" id="gearBtn" onclick="toggleMenu()">‚öôÔ∏è</button>
    </div>

    <input type="file" id="csv-upload" accept=".csv" onchange="handleCSVUpload(event)">

    <script>
        // Get current user name from stored data
        function getCurrentUserName() {
            // Try sessionStorage first, then localStorage
            const sessionProfile = sessionStorage.getItem('userProfile');
            const localProfile = localStorage.getItem('userProfile');
            
            let userProfile = null;
            if (sessionProfile) {
                userProfile = JSON.parse(sessionProfile);
            } else if (localProfile) {
                userProfile = JSON.parse(localProfile);
            }
            
            if (userProfile) {
                return userProfile['Full Name'] || userProfile['full_name'] || 'Resident';
            }
            
            // Fallback
            return localStorage.getItem("user_Full Name") || "Juan";
        }
        
        const CURRENT_USER_NAME = getCurrentUserName();
        let isEditMode = false, isRescheduleMode = false, selectedSourceId = null, slotLimit = 3;
        let userSchedule = [], allRequests = {}, locationChoices = [], activeSlotForLoc = null;
        let localScheduleState = {};
        let isDragging = false, dragStartSlot = null;

        firebase.initializeApp({ apiKey: "AIzaSyCZ6z7ldY06D1bUofMEoVUAwMu90bqivuo", databaseURL: "https://uppss-26c6f-default-rtdb.firebaseio.com" });
        const db = firebase.database();
        const supabaseClient = supabase.createClient('https://havsuikahafqciurmaeq.supabase.co', 'sb_publishable_pNAu0cwHGyX2Pn_DlX71Og_-t1KZq6C');

        async function fetchLocations() {
            const { data, error } = await supabaseClient.from('Locations').select('locations');
            if (data) {
                locationChoices = data.map(i => i.locations).filter(l => l);
                console.log("Locations loaded:", locationChoices);
            }
        }

        function build() {
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            let h = '';
            const timeSlots = [
                {start: '7:00 AM', end: '7:30 AM', id: '700AM'},
                {start: '7:30 AM', end: '8:00 AM', id: '730AM'},
                {start: '8:00 AM', end: '8:30 AM', id: '800AM'},
                {start: '8:30 AM', end: '9:00 AM', id: '830AM'},
                {start: '9:00 AM', end: '9:30 AM', id: '900AM'},
                {start: '9:30 AM', end: '10:00 AM', id: '930AM'},
                {start: '10:00 AM', end: '10:30 AM', id: '1000AM'},
                {start: '10:30 AM', end: '11:00 AM', id: '1030AM'},
                {start: '11:00 AM', end: '11:30 AM', id: '1100AM'},
                {start: '11:30 AM', end: '12:00 PM', id: '1130AM'},
                {start: '12:00 PM', end: '12:30 PM', id: '1200PM'},
                {start: '12:30 PM', end: '1:00 PM', id: '1230PM'},
                {start: '1:00 PM', end: '1:30 PM', id: '100PM'},
                {start: '1:30 PM', end: '2:00 PM', id: '130PM'},
                {start: '2:00 PM', end: '2:30 PM', id: '200PM'},
                {start: '2:30 PM', end: '3:00 PM', id: '230PM'},
                {start: '3:00 PM', end: '3:30 PM', id: '300PM'},
                {start: '3:30 PM', end: '4:00 PM', id: '330PM'},
                {start: '4:00 PM', end: '4:30 PM', id: '400PM'},
                {start: '4:30 PM', end: '5:00 PM', id: '430PM'},
                {start: '5:00 PM', end: '5:30 PM', id: '500PM'},
                {start: '5:30 PM', end: '6:00 PM', id: '530PM'},
                {start: '6:00 PM', end: '6:30 PM', id: '600PM'},
                {start: '6:30 PM', end: '7:00 PM', id: '630PM'},
                {start: '7:00 PM', end: '7:30 PM', id: '700PM'},
                {start: '7:30 PM', end: '8:00 PM', id: '730PM'}
            ];
            
            timeSlots.forEach(slot => {
                h += `<tr><td class="time-col">
                    <span class="time-label time-start">${slot.start}</span>
                    <span class="time-label time-end">${slot.end}</span>
                </td>`;
                days.forEach(day => {
                    const fullId = `${day}-${slot.id}`;
                    h += `<td><div class="slot" id="${fullId}" 
                        onclick="slotClick(event, this)"
                        onmousedown="handleDragStart(event, this)"
                        onmouseenter="handleDragEnter(event, this)"
                        onmouseup="handleDragEnd(event)"></div></td>`;
                });
                h += `</tr>`;
            });
            document.getElementById('grid').innerHTML = h;
        }

        function handleDragStart(e, el) {
            if (!isEditMode) return;
            e.preventDefault(); // Prevent text selection
            isDragging = true;
            dragStartSlot = el;
            if (!el.classList.contains('locked')) {
                el.classList.toggle('available');
                localScheduleState[el.id] = el.classList.contains('available');
            }
            // Prevent text selection during drag
            document.body.style.userSelect = 'none';
            document.body.style.webkitUserSelect = 'none';
        }

        function handleDragEnter(e, el) {
            if (!isEditMode || !isDragging) return;
            if (!el.classList.contains('locked')) {
                // Match the state of the starting slot
                if (dragStartSlot) {
                    const shouldBeAvailable = dragStartSlot.classList.contains('available');
                    if (shouldBeAvailable) {
                        el.classList.add('available');
                    } else {
                        el.classList.remove('available');
                    }
                    localScheduleState[el.id] = shouldBeAvailable;
                }
            }
        }

        function handleDragEnd(e) {
            if (!isEditMode) return;
            isDragging = false;
            dragStartSlot = null;
            // Re-enable text selection
            document.body.style.userSelect = '';
            document.body.style.webkitUserSelect = '';
        }

        // Add global mouseup to catch drag end anywhere
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                dragStartSlot = null;
                // Re-enable text selection
                document.body.style.userSelect = '';
                document.body.style.webkitUserSelect = '';
            }
        });

        function slotClick(e, el) {
            if (isDragging) return; // Ignore clicks during drag
            
            if (isRescheduleMode) {
                handleRescheduleAction(el);
            } else if (isEditMode) { 
                if (!el.classList.contains('locked')) {
                    el.classList.toggle('available');
                    localScheduleState[el.id] = el.classList.contains('available');
                }
            } else if (el.classList.contains('locked')) {
                showLocationPicker(e, el.id);
            }
        }

        function handleDayClick(dayName) {
            showConfirmDialog(
                'Delete Week Schedule',
                `Delete all availability schedule for <strong>${dayName}</strong>?`,
                () => deleteDaySchedule(dayName)
            );
        }

        function deleteDaySchedule(dayName) {
            const slotsToRemove = userSchedule.filter(slot => {
                const clean = slot.replace("(/)", "");
                return clean.startsWith(dayName + "-");
            });
            
            const newSchedule = userSchedule.filter(slot => {
                const clean = slot.replace("(/)", "");
                return !clean.startsWith(dayName + "-");
            });
            
            // Also remove any approved requests for this day
            const dayRequests = Object.keys(allRequests).filter(k => {
                const req = allRequests[k];
                if (req.resident === CURRENT_USER_NAME && req.status === 'approved') {
                    const slotId = req.slot_id.replace(/[:\s]/g, "");
                    return slotId.startsWith(dayName + "-");
                }
                return false;
            });
            
            const updates = {};
            dayRequests.forEach(k => {
                updates[`requests/${k}/status`] = 'declined';
            });
            
            if (Object.keys(updates).length > 0) {
                db.ref().update(updates);
            }
            
            db.ref(`schedules/${CURRENT_USER_NAME}/available_slots`).set(newSchedule);
            toast(`‚úÖ Deleted ${slotsToRemove.length} slots for ${dayName}`);
        }

        function showConfirmDialog(title, message, onConfirm) {
            document.getElementById('dialog-title').innerText = title;
            document.getElementById('dialog-message').innerHTML = message;
            document.getElementById('confirm-overlay').style.display = 'block';
            document.getElementById('confirm-dialog').style.display = 'block';
            
            const confirmBtn = document.getElementById('dialog-confirm');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.onclick = () => {
                onConfirm();
                closeDialog();
            };
        }

        function closeDialog() {
            document.getElementById('confirm-overlay').style.display = 'none';
            document.getElementById('confirm-dialog').style.display = 'none';
        }

        function showLocationPicker(e, slotId) {
            activeSlotForLoc = slotId;
            const picker = document.getElementById('location-picker');
            
            const viewportHeight = window.innerHeight;
            const estimatedHeight = Math.min(locationChoices.length * 40 + 100, 300);
            
            let top = e.clientY;
            if (top + estimatedHeight > viewportHeight) {
                top = viewportHeight - estimatedHeight - 10;
            }
            
            picker.style.display = 'block';
            picker.style.top = `${top}px`;
            picker.style.left = `${e.clientX}px`;
            
            let html = locationChoices.map(loc => 
                `<div class="loc-option" onclick="applyLocation('${loc.replace(/'/g, "\\'")}')">${loc}</div>`
            ).join('');
            html += `<div class="loc-option" style="color:#EF4444; border-top:1px solid #eee; margin-top:5px;" onclick="applyLocation('')">‚ùå Clear</div>`;
            
            picker.innerHTML = html;
            
            setTimeout(() => {
                const closeHandler = (evt) => {
                    if (!picker.contains(evt.target)) {
                        picker.style.display = 'none';
                        document.removeEventListener('click', closeHandler);
                    }
                };
                document.addEventListener('click', closeHandler);
            }, 10);
        }

        async function applyLocation(loc) {
            const updates = {};
            Object.keys(allRequests).forEach(key => {
                const req = allRequests[key];
                if (req.resident === CURRENT_USER_NAME && req.slot_id.replace(/[:\s]/g, "") === activeSlotForLoc && req.status === 'approved') {
                    updates[`requests/${key}/Location`] = loc;
                }
            });
            await db.ref().update(updates);
            db.ref(`schedules/${CURRENT_USER_NAME}/locations/${activeSlotForLoc}`).set(loc);
            toast(loc ? `üìç Assigned to ${loc}` : "‚ùå Location cleared");
        }

        async function handleRescheduleAction(el) {
            if (!selectedSourceId) {
                if (el.querySelector('.initials-badge')) {
                    selectedSourceId = el.id; 
                    el.classList.add('source-selected');
                    toast("üëâ Pick destination slot");
                }
            } else {
                const targetId = el.id;
                const sourceClean = selectedSourceId.replace(/[:\s]/g, "");
                const moves = Object.keys(allRequests).filter(k => 
                    allRequests[k].resident === CURRENT_USER_NAME && 
                    allRequests[k].slot_id.replace(/[:\s]/g, "") === sourceClean
                );
                
                if (moves.length > 0) {
                    const updates = {};
                    moves.forEach(k => updates[`requests/${k}/slot_id`] = targetId);
                    
                    // Always revert source slot to purple (available) state
                    const newSchedule = userSchedule.map(s => {
                        const clean = s.replace("(/)", "");
                        if (clean === sourceClean) {
                            // Remove (/) marker if present, making it purple again
                            return s.replace("(/)", "");
                        }
                        return s;
                    });
                    
                    // Update schedule to revert source slot
                    updates[`schedules/${CURRENT_USER_NAME}/available_slots`] = newSchedule;
                    
                    await db.ref().update(updates);
                    toggleRescheduleMode();
                    toast("‚úÖ Rescheduled successfully!");
                }
            }
        }

        function toggleRescheduleMode() {
            isRescheduleMode = !isRescheduleMode; 
            isEditMode = false;
            document.getElementById('mainBody').className = isRescheduleMode ? 'reschedule-mode-active' : '';
            document.getElementById('mode-banner').innerText = isRescheduleMode ? 'üîÑ RESCHEDULE MODE ACTIVE' : '‚úçÔ∏è EDIT MODE ACTIVE - DRAG TO SELECT';
            document.getElementById('reschedBtn').innerText = isRescheduleMode ? "‚ùå Cancel" : "üîÑ Reschedule";
            selectedSourceId = null;
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('source-selected'));
            closeMenu();
        }

        function handleEditClick() {
            isEditMode = !isEditMode; 
            isRescheduleMode = false;
            document.getElementById('mainBody').className = isEditMode ? 'edit-mode-active' : '';
            document.getElementById('editLabel').innerText = isEditMode ? "üíæ Save" : "‚úçÔ∏è Edit Mode";
            
            if (isEditMode) {
                localScheduleState = {};
                toast("‚úçÔ∏è Edit Mode: Click or drag to select slots");
            } else {
                saveData();
            }
            closeMenu();
        }

        function saveData() {
            const slots = [];
            document.querySelectorAll('.slot').forEach(s => {
                if (s.classList.contains('locked')) slots.push(s.id + "(/)");
                else if (s.classList.contains('available')) slots.push(s.id);
            });
            db.ref(`schedules/${CURRENT_USER_NAME}/available_slots`).set(slots);
            localScheduleState = {};
            toast("üíæ Schedule saved!");
        }

        function render(snap) {
            const snapVal = snap.val() || {};
            userSchedule = snapVal.available_slots || [];
            const locs = snapVal.locations || {};
            
            document.querySelectorAll('.slot').forEach(s => { 
                s.className = 'slot'; 
                s.innerHTML = ''; 
            });
            
            const counts = {};

            Object.values(allRequests).forEach(req => {
                if (req.resident === CURRENT_USER_NAME && req.status === 'approved') {
                    const id = req.slot_id.replace(/[:\s]/g, "");
                    const cell = document.getElementById(id);
                    if (cell) {
                        counts[id] = (counts[id] || 0) + 1;
                        cell.innerHTML += `<div class="initials-badge">${req.applicant.split(' ').map(n=>n[0]).join('.')}.</div>`;
                    }
                }
            });

            userSchedule.forEach(raw => {
                const clean = raw.replace("(/)", "");
                const el = document.getElementById(clean);
                if (el) {
                    const isLocked = raw.includes("(/)") || (counts[clean] > 0);
                    if (isLocked) {
                        el.classList.add('locked');
                        if (locs[clean]) {
                            el.innerHTML += `<div class="location-tag">${locs[clean]}</div>`;
                        }
                    } else {
                        el.classList.add('available');
                    }
                }
            });
        }

        function toggleMenu() {
            const menu = document.getElementById('fabMenu');
            const btn = document.getElementById('gearBtn');
            menu.classList.toggle('show');
            btn.classList.toggle('active');
        }

        function closeMenu() {
            const menu = document.getElementById('fabMenu');
            const btn = document.getElementById('gearBtn');
            menu.classList.remove('show');
            btn.classList.remove('active');
        }

        function triggerCSVUpload() {
            document.getElementById('csv-upload').click();
            closeMenu();
        }

        async function handleCSVUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const text = await file.text();
            const lines = text.split('\n').filter(l => l.trim());
            const slots = [];
            
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const day = parts[0].trim();
                    const time = parts[1].trim().replace(/[:\s]/g, '');
                    const slotId = `${day}-${time}`;
                    slots.push(slotId);
                }
            });
            
            db.ref(`schedules/${CURRENT_USER_NAME}/available_slots`).set(slots);
            toast("üìÑ CSV imported successfully!");
            closeMenu();
        }

        function toast(msg) {
            const el = document.getElementById('toast');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // Initialize
        build();
        fetchLocations();
        
        // Listen for schedule changes
        db.ref(`schedules/${CURRENT_USER_NAME}`).on('value', render);
        
        // Listen for request changes
        db.ref('requests').on('value', (snap) => {
            allRequests = snap.val() || {};
            db.ref(`schedules/${CURRENT_USER_NAME}`).once('value').then(render);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UPLB AMIS Schedule Sync</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --primary: #531C79; 
            --success: #10b981; 
            --border: #E2E8F0; 
            --danger: #ef4444; 
            --text-black: #000000; 
            --text-muted: #64748b; 
            --notif-green: #49A631; 
        }
        
        body { font-family: 'Inter', sans-serif; background: #F8FAFC; user-select: none; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .app-title { color: var(--primary); font-size: clamp(32px, 8vw, 50px); font-weight: 900; text-align: center; margin: 20px 0 10px 0; letter-spacing: -2px; padding: 0 15px; text-transform: uppercase; }
        #editing-bar { display: none; background: var(--primary); color: white; text-align: center; padding: 8px; font-size: 0.75rem; font-weight: 900; letter-spacing: 1px; z-index: 1000; }

        .table-container { flex-grow: 1; background: white; overflow: auto; position: relative; width: 100%; border: 3px solid transparent; transition: border 0.3s; }
        body.is-editing .table-container { border-color: #E1BEE7; }

        table { width: 100%; border-collapse: collapse; min-width: 850px; table-layout: fixed; }
        thead th { position: sticky; top: 0; background: white; padding: 16px 4px; font-size: 0.85rem; font-weight: 900; color: var(--primary); border-bottom: 2px solid var(--primary); z-index: 400; text-transform: uppercase; }

        .time-col { position: sticky; left: 0; background: #FFFFFF; width: clamp(100px, 22vw, 135px); border-right: 1px solid var(--border); z-index: 800 !important; }
        .time-grid { display: flex; align-items: center; justify-content: center; height: 50px; gap: 4px; padding: 0 5px; }
        .t-cell { font-weight: 700; font-size: clamp(11px, 2.5vw, 13px); color: var(--primary); display: flex; align-items: baseline; }
        .t-cell small { font-size: 8px; font-weight: 400; margin-left: 1px; color: var(--text-muted); }
        .t-sep { color: #CBD5E1; font-weight: 300; }

        td { padding: 4px; border-bottom: 1px solid #F1F5F9; }
        .slot { height: 42px; background: #F8FAFC; border-radius: 6px; cursor: pointer; border: 1px solid #EDF2F7; transition: all 0.2s; }
        .slot.available { background: #E1BEE7 !important; border: 2px solid var(--primary); }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--notif-green); color: white; padding: 10px 24px; border-radius: 50px; font-size: 0.85rem; font-weight: 600; transition: 0.3s; z-index: 11000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        #toast.show { transform: translateX(-50%) translateY(0); }

        .fab-container { position: fixed; bottom: 30px; right: 25px; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 12px; z-index: 9999; }
        .fab-main { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; box-shadow: 0 6px 20px rgba(83, 28, 121, 0.3); }
        .fab-options { display: none; flex-direction: column; align-items: flex-end; gap: 10px; }
        .fab-container.active .fab-options { display: flex; }
        .option-label { background: white; padding: 8px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .option-btn { width: 45px; height: 45px; border-radius: 50%; border: none; color: white; font-size: 18px; cursor: pointer; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 10000; padding: 20px; box-sizing: border-box; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 480px; box-sizing: border-box; }
        .btn-modal { width: 100%; padding: 14px; border-radius: 12px; font-weight: 900; border: none; cursor: pointer; font-family: 'Inter'; margin-top: 8px; }
    </style>
</head>
<body>

    <h1 class="app-title">AMIS SYNC</h1>
    <div id="editing-bar">● LIVE EDITING MODE</div>

    <div id="toast"></div>

    <div id="modal-overlay" class="modal-overlay" onclick="if(event.target==this) closeModal()">
        <div class="modal">
            <h2 style="color:var(--primary); text-align:center; font-weight:900;">Automatic Sync</h2>
            <p style="font-size: 0.85rem; color: #444; margin: 10px 0;">Upload your AMIS CSV to populate availability.</p>
            <button class="btn-modal" style="background:var(--primary); color:white;" onclick="document.getElementById('fileInput').click()">UPLOAD CSV</button>
            <button class="btn-modal" style="background:#F1F5F9;" onclick="closeModal()">CANCEL</button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th class="time-col">TIME</th>
                    <th onclick="handleHeaderClick('Sunday')">SUN</th>
                    <th onclick="handleHeaderClick('Monday')">MON</th>
                    <th onclick="handleHeaderClick('Tuesday')">TUE</th>
                    <th onclick="handleHeaderClick('Wednesday')">WED</th>
                    <th onclick="handleHeaderClick('Thursday')">THU</th>
                    <th onclick="handleHeaderClick('Friday')">FRI</th>
                    <th onclick="handleHeaderClick('Saturday')">SAT</th>
                </tr>
            </thead>
            <tbody id="grid"></tbody>
        </table>
    </div>

    <div class="fab-container" id="fabMenu">
        <button class="fab-main" onclick="toggleFab()">⚙️</button>
        <div class="fab-options">
            <div onclick="openInstructions()">
                <span class="option-label">Sync CSV</span>
                <button class="option-btn" style="background:#6366f1;">✨</button>
            </div>
            <div onclick="toggleEdit()">
                <span class="option-label" id="editLabel">Edit Mode</span>
                <button class="option-btn" id="editIconBtn" style="background:var(--primary);">✍️</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" hidden onchange="handleCSV(event)">

<script>
    const RENDER_URL = "https://scheduleextractor.onrender.com/process";
    
    // 1. INITIALIZE FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyCZ6z7ldY06D1bUofMEoVUAwMu90bqivuo",
        databaseURL: "https://uppss-26c6f-default-rtdb.firebaseio.com"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    
    let currentUserName = "Guest";
    let isEditMode = false, isDragging = false, dragMode = true;

    // 2. LISTEN FOR DASHBOARD DATA
    window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'SYNC_USER_DATA') {
            currentUserName = event.data.name;
            showToast(`Connected as ${currentUserName}`);
            loadUserData(); // Load from cloud as soon as we know who the user is
        }
    });

    function build() {
        let h = '';
        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        for(let i=7; i<=19; i++) {
            let t = i > 12 ? i-12 : i;
            let nextT = (i+1) > 12 ? (i+1-12) : (i+1);
            let ampm = i >= 12 ? 'PM' : 'AM';
            [{s:`${t}:00`, e:`${t}:30`, id:'00'}, {s:`${t}:30`, e:`${nextT}:00`, id:'30'}].forEach(r => {
                h += `<tr><td class="time-col"><div class="time-grid"><span class="t-cell">${r.s}</span><span class="t-sep">-</span><span class="t-cell">${r.e}<small>${ampm}</small></span></div></td>`;
                days.forEach(day => {
                    h += `<td><div class="slot" id="${day}-${t}${r.id}${ampm}" onmousedown="slotStart(this)" onmouseover="slotDrag(this)"></div></td>`;
                });
                h += `</tr>`;
            });
        }
        document.getElementById('grid').innerHTML = h;
    }
    build();

    // 3. CLOUD SYNC LOGIC
    function loadUserData() {
        if (!currentUserName || currentUserName === "Guest") return;
        
        const userRef = db.ref('schedules/' + currentUserName);
        userRef.on('value', (snapshot) => {
            if (isEditMode) return; // Don't overwrite if user is currently painting
            const data = snapshot.val();
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('available'));
            if (data && data.available_slots) {
                data.available_slots.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('available');
                });
            }
        });
    }

    function save() {
        if (!currentUserName || currentUserName === "Guest") {
            showToast("Error: No User Identified");
            return;
        }
        const slots = [];
        document.querySelectorAll('.slot.available').forEach(s => slots.push(s.id));
        
        db.ref('schedules/' + currentUserName).set({
            available_slots: slots,
            lastUpdated: new Date().toLocaleString()
        }).then(() => {
            showToast("Cloud Updated");
        }).catch(err => {
            console.error(err);
            showToast("Firebase Error");
        });
    }

    // 4. CSV SYNC LOGIC (The "Fix")
    async function handleCSV(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        closeModal();
        showToast("Processing CSV...");
        
        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch(RENDER_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error("Server Error");

            const data = await response.json();
            
            // Mark all as available first
            document.querySelectorAll('.slot').forEach(s => s.classList.add('available'));
            
            // Remove availability for busy slots returned by Render
            if (data.busy_slots && Array.isArray(data.busy_slots)) {
                data.busy_slots.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.remove('available');
                });
                showToast("Schedule Imported!");
                save(); // Automatically push the CSV result to Firebase
            }
        } catch (e) {
            console.error(e);
            showToast("Sync Failed: Server Offline");
        } finally {
            event.target.value = '';
        }
    }

    // 5. UI CONTROLS
    function toggleEdit() {
        isEditMode = !isEditMode;
        document.body.classList.toggle('is-editing', isEditMode);
        document.getElementById('editing-bar').style.display = isEditMode ? 'block' : 'none';
        document.getElementById('editLabel').innerText = isEditMode ? "Save & Lock" : "Edit Mode";
        if (!isEditMode) save();
        toggleFab();
    }

    function slotStart(el) {
        if (!isEditMode) { showToast("Enter Edit Mode to change"); return; }
        isDragging = true;
        dragMode = !el.classList.contains('available');
        el.classList.toggle('available', dragMode);
    }
    
    function slotDrag(el) {
        if (isDragging && isEditMode) {
            el.classList.toggle('available', dragMode);
        }
    }

    document.onmouseup = () => isDragging = false;
    function toggleFab() { document.getElementById('fabMenu').classList.toggle('active'); }
    function openInstructions() { toggleFab(); document.getElementById('modal-overlay').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function showToast(msg) { 
        const t = document.getElementById('toast'); 
        t.innerText = msg; t.classList.add('show'); 
        setTimeout(() => t.classList.remove('show'), 2500); 
    }
</script>
</body>
</html>

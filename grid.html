<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UPLB AMIS Schedule Sync</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --primary: #531C79; 
            --success: #49A631; 
            --border: #E2E8F0; 
            --danger: #ef4444; 
            --bg-light: #F8FAFC;
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-light); user-select: none; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .app-title { color: var(--primary); font-size: clamp(32px, 8vw, 50px); font-weight: 900; text-align: center; margin: 20px 0 10px 0; letter-spacing: -2px; text-transform: uppercase; }
        #editing-bar { display: none; background: var(--primary); color: white; text-align: center; padding: 8px; font-size: 0.75rem; font-weight: 900; letter-spacing: 1px; }

        .table-container { flex-grow: 1; background: white; overflow: auto; width: 100%; border: 3px solid transparent; }
        body.is-editing .table-container { border-color: #E1BEE7; }

        table { width: 100%; border-collapse: collapse; min-width: 850px; table-layout: fixed; }
        thead th { position: sticky; top: 0; background: white; padding: 16px 4px; font-size: 0.85rem; font-weight: 900; color: var(--primary); border-bottom: 2px solid var(--primary); z-index: 400; }

        .time-col { position: sticky; left: 0; background: white; width: 130px; border-right: 1px solid var(--border); z-index: 500; }
        .time-grid { display: flex; align-items: center; justify-content: center; height: 50px; gap: 4px; }
        .t-cell { font-weight: 700; font-size: 13px; color: var(--primary); }

        td { padding: 4px; border-bottom: 1px solid #F1F5F9; vertical-align: top; }
        .slot { 
            min-height: 42px; background: #F8FAFC; border-radius: 6px; 
            cursor: pointer; border: 1px solid #EDF2F7; position: relative;
            display: flex; flex-wrap: wrap; gap: 2px; padding: 2px; align-content: flex-start;
        }
        .slot.available { background: #E1BEE7 !important; border: 2px solid var(--primary); }
        .slot.full { background: #fee2e2 !important; border: 2px solid var(--danger); cursor: not-allowed; }

        /* Initials Badge */
        .initials-tag {
            background: var(--primary); color: white; font-size: 9px; 
            font-weight: 800; padding: 2px 4px; border-radius: 4px;
            height: 16px; display: flex; align-items: center; justify-content: center;
        }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: var(--success); color: white; padding: 12px 28px; border-radius: 50px; font-size: 0.85rem; font-weight: 700; transition: 0.4s; z-index: 11000; }
        #toast.show { transform: translateX(-50%) translateY(0); }

        .fab-container { position: fixed; bottom: 30px; right: 25px; display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 12px; z-index: 9999; }
        .fab-main { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; }
        .option-label { background: white; padding: 8px 15px; border-radius: 10px; font-size: 0.8rem; font-weight: 800; color: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <h1 class="app-title">AMIS SYNC</h1>
    <div id="editing-bar">● LIVE EDITING MODE</div>
    <div id="toast"></div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th class="time-col">TIME</th>
                    <th>SUN</th><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th>
                </tr>
            </thead>
            <tbody id="grid"></tbody>
        </table>
    </div>

    <div class="fab-container" id="fabMenu">
        <button class="fab-main" onclick="this.parentElement.classList.toggle('active')">⚙️</button>
        <div style="display:none;" class="fab-options">
            <div onclick="toggleEdit()" style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <span class="option-label" id="editLabel">Edit Mode</span>
                <button style="width:45px; height:45px; border-radius:50%; border:none; background:var(--primary); color:white;">✍️</button>
            </div>
        </div>
    </div>

<script>
    // --- CONFIG ---
    const RENDER_URL = "https://scheduleextractor.onrender.com/process";
    const firebaseConfig = { apiKey: "AIzaSyCZ6z7ldY06D1bUofMEoVUAwMu90bqivuo", databaseURL: "https://uppss-26c6f-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // REPLACE WITH YOUR ACTUAL SUPABASE CREDENTIALS
    const supabase = Object.assign(window['supabase-js']).createClient('YOUR_SUPABASE_URL', 'YOUR_SUPABASE_KEY');

    let currentUserName = "Guest";
    let currentUserCategory = "";
    let userMaxCapacity = 1; 
    let isEditMode = false;

    // --- 1. GET INITIALS FUNCTION ---
    function getInitials(name) {
        return name.split(' ').map(n => n[0].toUpperCase() + ".").join('').replace(/\.\.$/, ".");
        // Converts "Abel V. Paner Jr." -> "A.V.P.J."
    }

    // --- 2. FETCH CAPACITY FROM SUPABASE ---
    async function fetchCapacity() {
        if (!currentUserName || currentUserName === "Guest") return;
        
        // Find user category first
        const { data: userData } = await supabase.from('users').select('category').eq('full_name', currentUserName).single();
        if (userData) {
            currentUserCategory = userData.category;
            // Check settings table for the capacity
            const { data: setts } = await supabase.from('settings').select('value').eq('category', currentUserCategory).single();
            if (setts) userMaxCapacity = parseInt(setts.value);
        }
    }

    // --- 3. LOAD DATA & RENDER INITIALS ---
    function syncAllData() {
        if (currentUserName === "Guest") return;

        // Listen to BOTH Availability and Approved Requests
        const scheduleRef = db.ref('schedules/' + currentUserName);
        const requestsRef = db.ref('requests');

        // Watch for changes
        Promise.all([scheduleRef.once('value'), requestsRef.once('value')]).then(snapshots => {
            const availSlots = snapshots[0].val()?.available_slots || [];
            const allRequests = snapshots[1].val() || {};

            // Clear Grid
            document.querySelectorAll('.slot').forEach(s => {
                s.classList.remove('available', 'full');
                s.innerHTML = ''; 
                s.dataset.count = 0;
            });

            // Apply Availability
            availSlots.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('available');
            });

            // Process Approved Requests for this resident
            Object.values(allRequests).forEach(req => {
                if (req.resident_name === currentUserName && req.status === 'Approved') {
                    const slotEl = document.getElementById(req.slot_id);
                    if (slotEl) {
                        // Add Initial Badge
                        const badge = document.createElement('div');
                        badge.className = 'initials-tag';
                        badge.innerText = getInitials(req.applicant_name);
                        slotEl.appendChild(badge);

                        // Track Capacity
                        let currentCount = parseInt(slotEl.dataset.count || 0) + 1;
                        slotEl.dataset.count = currentCount;

                        // Lock if Full
                        if (currentCount >= userMaxCapacity) {
                            slotEl.classList.add('full');
                            slotEl.classList.remove('available');
                        }
                    }
                }
            });
        });
    }

    // --- UI & GRID GEN ---
    function buildGrid() {
        let html = '';
        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        for(let i=7; i<=19; i++) {
            let hour = i > 12 ? i-12 : i;
            let ampm = i >= 12 ? 'PM' : 'AM';
            [{m:'00', label:`${hour}:00`}, {m:'30', label:`${hour}:30`}].forEach(row => {
                html += `<tr><td class="time-col"><div class="time-grid"><span class="t-cell">${row.label}<small>${ampm}</small></span></div></td>`;
                days.forEach(day => {
                    html += `<td><div class="slot" id="${day}-${hour}${row.m}${ampm}"></div></td>`;
                });
                html += `</tr>`;
            });
        }
        document.getElementById('grid').innerHTML = html;
    }

    function toggleEdit() {
        isEditMode = !isEditMode;
        document.body.classList.toggle('is-editing', isEditMode);
        document.getElementById('editing-bar').style.display = isEditMode ? 'block' : 'none';
        if (!isEditMode) saveSchedule();
        syncAllData();
    }

    async function saveSchedule() {
        const availableOnes = [];
        document.querySelectorAll('.slot.available').forEach(s => availableOnes.push(s.id));
        await db.ref('schedules/' + currentUserName).set({ available_slots: availableOnes });
        showToast("Changes Saved");
    }

    window.addEventListener('message', async (event) => {
        if (event.data?.type === 'SYNC_USER_DATA') {
            currentUserName = event.data.name;
            await fetchCapacity();
            syncAllData();
        }
    });

    buildGrid();
    function showToast(m) { const t = document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }
</script>
</body>
</html>

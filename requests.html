<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requests Inbox | Resident Portal</title>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
        @theme {
            --color-brand: #531C79;
            --color-brand-light: #F4EFF8;
            --font-sans: "Inter", system-ui, sans-serif;
        }
        .brand-title {
            font-family: 'Inter', sans-serif;
            color: #531C79;
            font-size: clamp(32px, 8vw, 50px);
            font-weight: 900;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: -2px;
            margin: 20px 0 5px 0;
            -webkit-font-smoothing: antialiased;
        }
        .card-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#F9FAFB] font-sans antialiased text-gray-900 min-h-screen p-4 md:p-8">

    <header class="mb-10">
        <h1 class="brand-title">REQUESTS</h1>
        <div id="user-pill" class="flex justify-center">
            <span class="bg-brand/5 text-brand text-[10px] font-black px-3 py-1 rounded-full border border-brand/10 uppercase tracking-widest animate-pulse">
                Establishing Connection...
            </span>
        </div>
    </header>

    <div id="inbox-container" class="max-w-xl mx-auto space-y-3">
        <div id="loader" class="flex flex-col items-center py-20">
            <div class="w-8 h-8 border-4 border-brand/10 border-t-brand rounded-full animate-spin"></div>
            <p class="text-gray-400 text-[10px] mt-4 font-bold uppercase tracking-tighter">Syncing with Realtime Database...</p>
        </div>
    </div>

    <script type="module">
        // IMPORT REALTIME DATABASE INSTEAD OF FIRESTORE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCZ6z7ldY06D1bUofMEoVUAwMu90bqivuo",
            authDomain: "uppss-26c6f.firebaseapp.com",
            databaseURL: "https://uppss-26c6f-default-rtdb.firebaseio.com/", // ADDED FROM YOUR IMAGE
            projectId: "uppss-26c6f",
            storageBucket: "uppss-26c6f.firebasestorage.app",
            messagingSenderId: "734429390148",
            appId: "1:734429390148:web:97b7cad461e5505943a311"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const container = document.getElementById('inbox-container');
        const loader = document.getElementById('loader');

        // 1. RECEIVE NAME FROM DASHBOARD
        window.addEventListener('message', (event) => {
            if (event.data.type === 'SYNC_USER_DATA') {
                startResidentSession(event.data.name);
            }
        });

        function startResidentSession(residentName) {
            document.getElementById('user-pill').innerHTML = `
                <span class="bg-brand/5 text-brand text-[10px] font-black px-3 py-1 rounded-full border border-brand/10 uppercase tracking-widest">
                    Resident: ${residentName}
                </span>
            `;

            // 2. REALTIME DATABASE QUERY
            // We reference the 'requests' node and filter by resident name
            const requestsRef = ref(db, 'requests');
            const pendingQuery = query(requestsRef, orderByChild('resident'), equalTo(residentName));

            onValue(pendingQuery, (snapshot) => {
                loader.classList.add('hidden');
                container.innerHTML = "";

                if (!snapshot.exists()) {
                    showEmptyState();
                    return;
                }

                let hasPending = false;
                snapshot.forEach((childSnapshot) => {
                    const id = childSnapshot.key;
                    const data = childSnapshot.val();

                    // Realtime Database doesn't support multiple filters easily in one query, 
                    // so we check for 'pending' status here.
                    if (data.status === "pending") {
                        hasPending = true;
                        renderRequestCard(id, data);
                    }
                });

                if (!hasPending) showEmptyState();
            });
        }

        function showEmptyState() {
            container.innerHTML = `
                <div class="text-center py-16 bg-white rounded-3xl border border-gray-100 shadow-sm">
                    <p class="text-gray-400 font-bold text-sm uppercase tracking-tight">Inbox Clear</p>
                    <p class="text-gray-300 text-[10px] mt-1 italic uppercase font-medium">No pending requests for you</p>
                </div>`;
        }

        function renderRequestCard(id, data) {
            const html = `
                <div id="card-${id}" class="card-enter bg-white border border-gray-100 rounded-2xl p-4 shadow-sm flex items-center justify-between group transition-all hover:border-brand/20">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 rounded-xl bg-brand/10 text-brand flex items-center justify-center font-black text-sm uppercase">
                            ${(data.applicant || "?").charAt(0)}
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900 text-sm leading-none">${data.applicant}</h4>
                            <p class="text-[10px] text-brand font-black uppercase mt-1 tracking-tight">${data.slot_id}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="processAction('${id}', 'declined')" class="p-2 rounded-lg border border-gray-100 text-gray-400 hover:bg-red-50 hover:text-red-500 hover:border-red-100 transition-all cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <button onclick="processAction('${id}', 'approved')" class="px-5 py-2 rounded-lg bg-brand text-white font-black text-[10px] uppercase tracking-widest hover:shadow-lg hover:shadow-brand/20 active:scale-95 transition-all cursor-pointer">
                            Approve
                        </button>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        // 3. ACTION HANDLER (UPDATE STATUS)
        window.processAction = async (id, newStatus) => {
            const card = document.getElementById(`card-${id}`);
            card.style.opacity = "0.3";
            card.style.pointerEvents = "none";

            try {
                const updates = {};
                updates[`/requests/${id}/status`] = newStatus;
                await update(ref(db), updates);
            } catch (err) {
                console.error("Update failed:", err);
                card.style.opacity = "1";
                card.style.pointerEvents = "auto";
                alert("Database Error: Check your Security Rules.");
            }
        };
    </script>
</body>
</html>
